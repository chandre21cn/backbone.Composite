/*Backbone.Composite*/(function(t,i){function e(t){return"[object Array]"===Object.prototype.toString.apply(t)}function n(t){var i=t.split(" "),e=i[0],n=i[1];return{target:n,event:e}}function s(t,i){var n,s,r,o,h,f,l;for(n=0,s=t.length;s>n;n++){if(h=t[n],"string"==typeof h)if(r=h.lastIndexOf("."),-1===r)h=this[h],f=this;else{if(o=h.slice(r+1),l=h.slice(0,r),f=this.getItem(l),e(f)){for(j=0,s=f.length;s>j;j++)tpmView=f[j],i(l,o,tpmView,tpmView[o]);continue}h=f[o]}i("function","function",f,h)}}function r(t,i,e){s.call(this,e,function(e,n,s,r){t.on(i,r,s)})}function o(t,i,n){var s,o;if(e(t))for(s=0,o=t.length;o>s;s++)r.call(this,t[s],i,n);else r.call(this,t,i,n)}function h(t,i){var e,n=this.ve[t].bind;if(!n)return!1;for(e in n)o.call(this,i,e,n[e]);return!0}function f(t,i){var e,n,s,r=this.ve[t].listen;for(e in r)n=r[e].split(" "),s=this.getItem(n[1]),o(s,n[0],[i[e]])}function l(t,e,n){var s,r,o,h=this.nv[t];""!==h&&(o=h.split(" "),r=this.getItem(o[0]),r?(s=r.$el,o[1]&&(s=s.find(o[1]))):s=i(h),n?s.prepend(e.$el):s.append(e.$el))}function u(){var t,i,e,n,s,r=this.itemViews,o=this.iv;for(t in r)i=o[t]=r[t],e=this.ve[t]={},this.nv[t]="",e.bind={},e.listen={},"function"==typeof i&&(i=o[t]=i()),n=this.exportAPI[t],s=this.exportEvent[t],i&&(n&&v.call(this,i,n),s&&c.call(this,i,s))}function a(){var t,i,e,s,r,h,f,l,u,a=this.viewsEvents;for(f in a)if(t=a[f],"function"==typeof t&&(t=t()),i=n(f),e=i.event,s=i.target,r=this.getItem(s),-1===s.indexOf(".")&&(binds=this.ve[s].bind,binds[e]=t),r&&t.length){o.call(this,r,e,t);for(var p=0,v=t.length;v>p;p++)h=t[p],"function"!=typeof h&&(u=h.split("."),2===u.length&&-1!==l&&(this.ve[u[0]].listen[[u[1]]]=f))}}function p(){var t,n,s,r,o,h,f,l,u,a,p,v,c,g=this.nestViews;for(a in g)if(l=i(),f=null,u=a.split(" "),n=u[0],p=u[1]?u[1]:null,t=this.getItem(n),t?(e(t)&&(t=t[0]),h=t.$el,p&&(h=h.find(p))):h=i(a),!(1>h.size())){for(r=g[a],"function"==typeof r&&(r=r()),o=r.length,s=0;o>s;s++){var d=r[s];if("object"==typeof d)f=d.$el?d.$el:d;else if("string"==typeof d)if(t=this.getItem(d),t&&-1===d.indexOf(".")&&(this.nv[d]=a),e(t))for(v=0,c=t.length;c>v;v++)l=l.add(t[v].$el);else f=t?t.$el:i(d);f&&f.size()>=1&&(l=l.add(f))}l.size()>=1&&h.append(l)}}function v(t,i){var e,n,s,r;if("string"==typeof t&&(t=this.getItem(t),!t))throw Error("item "+t+" not found");for(var n=0,s=i.length;s>n;n++){if(e=i[n],r=t[e],!r)throw Error("API "+e+" not found");this[e]=function(i){return function(){i.apply(t,arguments)}}(r)}}function c(t,i){function e(t){return function(){Array.prototype.unshift.call(arguments,t),r.trigger.apply(r,arguments)}}var n,s,r;if("string"==typeof t&&(t=this.getItem(t),!t))throw Error("item "+t+" not found");for(var n=0,s=i.length;s>n;n++)r=this,this.listenTo(t,i[n],e(i[n]))}t.Composite=t.View.extend({items:{},events:{},nests:{},exportAPI:{},exportEvent:{},constructor:function(){this.iv={},this.ve={},this.nv={},this.itemViews=this.items,this.viewsEvents=this.events,this.nestViews=this.nests,u.apply(this),a.apply(this),p.apply(this),this.initialize()},setItem:function(t,i,e){var e=e||!0;return this.trigger("set",t,i),this.trigger("set:"+t,t,i),this.iv[t]?(e&&h.call(this,t,i),void 0):(this.iv[t]=i,this.trigger("add",t,i),this.trigger("add:"+t,t,i),void 0)},getItem:function(t){var i,e,n;if("string"!=typeof t)return null;if(n=t.indexOf("."),-1===n)return this.iv[t]?this.iv[t]:null;var s;return i=t.slice(n+1),e=t.slice(0,n),s=this.iv[e],s?"function"==typeof s.getItem?s.getItem(i):s:null},pushItem:function(t,i,n){var s,r=this.getItem(t);if(s={bind:!0,listen:!0,nest:!0,prepend:!1},_.extend(s,n),!r)throw"subview not found";if(!e(r))throw"Subview is not an array";r.push(i),s.bind&&h.call(this,t,i),s.listen&&f.call(this,t,i),s.nest&&l.call(this,t,i,s.prepend),this.trigger("append",t,i),this.trigger("append:"+t,i)},deleteItem:function(t){return this.iv[t]?(delete this.iv[t],this.ve[t]&&delete this.ve[t],this.trigger("remove"),this.trigger("remove:"+t),!0):!1},_exportAPI:v,_exportEvent:c})})(Backbone,jQuery);