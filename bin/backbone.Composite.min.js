/*Backbone.Composite*/(function(t,i){function e(t){var i=t.split(" "),e=i[0],n=i[1];return{target:n,event:e}}function n(t,i){var e,n,s,r,o,h,l;for(e=0,n=t.length;n>e;e++){if(o=t[e],"string"==typeof o)if(s=o.lastIndexOf("."),-1===s)o=this[o],h=this;else{if(r=o.slice(s+1),l=o.slice(0,s),h=this.getItem(l),_.isArray(h)){for(j=0,n=h.length;n>j;j++)tpmView=h[j],i(l,r,tpmView,tpmView[r]);continue}o=h[r]}else _.isObject(o)&&(_.isFunction(o)||(h=o.context,o=o.method));i("function","function",h,o)}}function s(t,i,e){n.call(this,e,function(e,n,s,r){s=s||window,t.on(i,r,s)})}function r(t,i,e){var n,r;if(_.isArray(t))for(n=0,r=t.length;r>n;n++)s.call(this,t[n],i,e);else s.call(this,t,i,e)}function o(t,i){var e,n=this.ve[t].bind;if(!n)return!1;for(e in n)r.call(this,i,e,n[e]);return!0}function h(t,i){var e,n,s,o=this.ve[t].listen;for(e in o)n=o[e].split(" "),s=this.getItem(n[1]),r(s,n[0],[{context:i,method:i[e]}])}function l(t,e,n){var s,r,o,h=this.nv[t];""!==h&&(o=h.split(" "),r=this.getItem(o[0]),r?(s=r.$el,o[1]&&(s=s.find(o[1]))):s=i(h),n?s.prepend(e.$el):s.append(e.$el))}function f(){var t,i,e,n,s,r=this.itemViews,o=this.iv;for(t in r)i=o[t]=r[t],e=this.ve[t]={},this.nv[t]="",e.bind={},e.listen={},"function"==typeof i&&(i=o[t]=i()),n=this.exportAPI[t],s=this.exportEvent[t],i&&(n&&v.call(this,i,n),s&&p.call(this,i,s))}function u(){var t,i,n,s,o,h,l,f,u,a=this.viewsEvents;for(l in a)if(t=a[l],"function"==typeof t&&(t=t()),i=e(l),n=i.event,s=i.target,o=this.getItem(s),-1===s.indexOf(".")&&(binds=this.ve[s].bind,binds[n]=t),o&&t.length){r.call(this,o,n,t);for(var v=0,p=t.length;p>v;v++)h=t[v],"function"!=typeof h&&(u=h.split("."),2===u.length&&-1!==f&&(this.ve[u[0]].listen[[u[1]]]=l))}}function a(){var t,e,n,s,r,o,h,l,f,u,a,v,p,c=this.nestViews;for(u in c)if(l=i(),h=null,f=u.split(" "),e=f[0],a=f[1]?f[1]:null,t=this.getItem(e),t?(_.isArray(t)&&(t=t[0]),o=t.$el,a&&(o=o.find(a))):o=i(u),!(1>o.size())){for(s=c[u],"function"==typeof s&&(s=s()),r=s.length,n=0;r>n;n++){var g=s[n];if("object"==typeof g)h=g.$el?g.$el:g;else if("string"==typeof g)if(t=this.getItem(g),t&&-1===g.indexOf(".")&&(this.nv[g]=u),_.isArray(t))for(v=0,p=t.length;p>v;v++)l=l.add(t[v].$el);else h=t?t.$el:i(g);h&&h.size()>=1&&(l=l.add(h))}l.size()>=1&&o.append(l)}}function v(t,i){var e,n,s,r;if("string"==typeof t&&(t=this.getItem(t),!t))throw Error("item "+t+" not found");for(var n=0,s=i.length;s>n;n++){if(e=i[n],r=t[e],!r)throw Error("API "+e+" not found");this[e]=function(i){return function(){i.apply(t,arguments)}}(r)}}function p(t,i){function e(t){return function(){Array.prototype.unshift.call(arguments,t),r.trigger.apply(r,arguments)}}var n,s,r;if("string"==typeof t&&(t=this.getItem(t),!t))throw Error("item "+t+" not found");for(var n=0,s=i.length;s>n;n++)r=this,this.listenTo(t,i[n],e(i[n]))}var c=t.Composite=function(){this.iv={},this.ve={},this.nv={},this.itemViews=this.items,this.viewsEvents=this.events,this.nestViews=this.nests,f.apply(this),u.apply(this),a.apply(this),this.initialize.apply(this,arguments)};_.extend(c.prototype,t.Events,{initialize:function(){},items:{},events:{},nests:{},exportAPI:{},exportEvent:{},setItem:function(t,i,e){var e=e||!0;return this.trigger("set",t,i),this.trigger("set:"+t,t,i),this.iv[t]?(e&&o.call(this,t,i),void 0):(this.iv[t]=i,this.trigger("add",t,i),this.trigger("add:"+t,t,i),void 0)},getItem:function(t){var i,e,n;if("string"!=typeof t)return null;if(n=t.indexOf("."),-1===n)return this.iv[t]?this.iv[t]:null;var s;return i=t.slice(n+1),e=t.slice(0,n),s=this.iv[e],s?"function"==typeof s.getItem?s.getItem(i):s:null},pushItem:function(t,i,e){var n,s=this.getItem(t);if(n={bind:!0,listen:!0,nest:!0,prepend:!1},_.extend(n,e),!s)throw"subview not found";if(!_.isArray(s))throw"Subview is not an array";s.push(i),n.bind&&o.call(this,t,i),n.listen&&h.call(this,t,i),n.nest&&l.call(this,t,i,n.prepend),this.trigger("push",t,i),this.trigger("push:"+t,i)},deleteItem:function(t){return this.iv[t]?(delete this.iv[t],this.ve[t]&&delete this.ve[t],this.trigger("delete"),this.trigger("delete:"+t),!0):!1},_exportAPI:v,_exportEvent:p}),c.extend=t.View.extend})(Backbone,jQuery);